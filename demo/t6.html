<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hexo</title>
  <style>
  	body *{
  		padding: 0px;
  		margin: 0px;
  		font-size: 14px;
  	}
  	body * {
  		border-bottom: 1px red solid;
  	}
  	.title {
  		font-weight: bold;
  		background: #acc;
  		padding-left: 10px
  	}
  	.title2 {
  		background: #ddd;
  		list-style: none;
  		padding-left: 60px
  	}
  	li, div{
  		padding: 3px 0 3px 110px;
  	}
  </style>
  <script src="//cdn.bootcss.com/jquery/1.12.1/jquery.js"></script>
</head>
<body>
	<div id=a style="height: 100px"></div>
	<script>
		window.onload = function() {
			
			var data = {
				title : '组织架构',
				departList : [{
						departName : '开发1部',
						leaderName: '张三',
						group: [
							{
								groupName: '前端组',　
								groupManager: 'aa',
								userList: [
									{name: 'a', sex:'男'},
									{name: 'b', sex:'男'},
								]
							}, {
								groupName: 'java组',
								groupManager: 'cdsd',　
								userList: [
									{name: 'h', sex:'男'},
									{name: 'i', sex:'女'},
									{name: 'j', sex:'男'},
									{name: 'k', sex:'男'},
								]
							}, {
								groupName: 'db组',　
								groupManager: 'bb',
								userList: [
									{name: 'x', sex:'男'}
								]
							},
						]
					}, {
						departName : '开发2部',
						leaderName: '李四',
						group: [
							{
								groupName: '前端组',
								groupManager: 'cc',　
								userList: [
									{name: 'l', sex:'男'},
								]
							}, {
								groupName: 'php组',　
								groupManager: 'dd',
								userList: [
									{name: 'm', sex:'男'},
									{name: 'n', sex:'男'},
									{name: 'o', sex:'女'},
									{name: 'p', sex:'男'},
									{name: 'p', sex:'男'},
								]
							}
						]
					}
				]
			};
			
			var html = [
				'<div>{title}</div>',
				'<div>',
					'<each departList="d">',
						'<div class="title">{d.departName}-{d.leaderName}</div>',
						'<each d.group=g>',
							'<li class="title2">{g.groupName}-组长：{g.groupManager}</li>',
							'<each g.userList=u>',
								'<li>{u.name}({u.sex}) ({d.departName})</li>',
							'</each>',
						'</each>',
					'</each>',
					
				'</div>',
			].join('');
			
			var d = new Date().getTime();
			var html = bonTemplate(html, data);
			document.body.innerHTML = html;
			console.log('time:', new Date().getTime() - d);
		};
		
		function bonTemplate(html, data) {
			return new Node({
				template: html,
				scopeChain: [{
					scope: null,
					data: data
				}]
			}).getHtml();
		}
		
		
		function EachBlock(opts) {
			for(var k in opts) {
				this[k] = opts[k];
			}
			this.childNodes = this.getNodes();
		}
		EachBlock.prototype = {
			getHtml: function() {
				var me = this;
				
				var html = [];
				this.childNodes.forEach(function(c, i) {
					html.push(c.getHtml());
				});
				return html.join('');
			},
			getNodes: function() {
				var me = this;
				var nodes = [];
				
				var matchs = /(?:(\w+)\.)?(\w+)/.exec(this.arrVar);
				var prefix = matchs[1];
				var suffix = matchs[2];
				
				var data = this.getChainMappingValue(prefix, suffix);
				
				data && data.forEach(function(d, i) {
					// 取得父给作用域，再加上自己的作用域
					var scopeChain = jQuery.extend(true, [], me.scopeChain);
					scopeChain.unshift({
						scope: me.itemVar,
						data: d
					});
					var node = new Node({
						template: me.template,
						scopeChain: scopeChain,
					});
					
					nodes.push(node);
				});
				return nodes;
			},
			getChainMappingValue: function(prefix, suffix) {
				var arr = this.scopeChain.filter(function(s, i) {
					return s.scope == prefix;
				});
				if(arr.length) {
					return arr[0].data[suffix];
				}
			}
		};
		
		function Node(opts) {
			for(var k in opts) {
				this[k] = opts[k];
			}
			this.children = this.getBlocks();
			this.placeholderTemplate = this.getPlaceholderTemplate();	// 替换占位符后的template
		}
		
		Node.prototype = {
			
			getHtml: function() {
				var me = this;
				var html = this.placeholderTemplate;
				var sc = this.scopeChain;
				
				// 如果scope为null，　说明是一级数据, 匹配一级数据时不带前缀
				html = html.replace(/{(?:(\w+)\.)?(\w+)}/g, function(x, prefix, suffix) {
					// 遍历scopeChain，找到prefix所在的一项，取data
					return me.getChainMappingValue(prefix, suffix);
				});
				
				if(this.children.length > 0) {	// 如果有子block, 替换为子block.getHtml();
					html = html.replace(/\[(\w+)\]/g, function(x, a) {
						var block = me.getBlockById(a);
						return block.getHtml();
					});
				}
				
				return html;
			},
			
			getChainMappingValue: function(prefix, suffix) {
				var arr = this.scopeChain.filter(function(s, i) {
					return s.scope == prefix;
				});
				if(arr.length) {
					return arr[0].data[suffix];
				}
			},
			
			getBlocks: function() {	// 获取一级子block(不包含孙block)
				var me = this;
				var tpl = this.template;
				var reg = /<\/?each[^>]*>/g;
				var r, stack = [], arr = [];
				while(r = reg.exec(tpl)) {
					
					var result = /<each\s+([\w.]+)=["']?(\w+)["']?>/.exec(r[0]);
					if(result) {
						var arrVar 	= result[1];
						var itemVar = result[2];
						
						var ebOption = {
							begin: r.index + r[0].length,	// 开始位置(从block内容开始)
							beginOuter: r.index,			// 开始位置(从block开始)
							arrVar: arrVar,
							itemVar: itemVar
						};
						stack.push(ebOption);
						
						// 顺序要反序，因为替换成占位符时要用到开始和结束位置，如果先替换前面的，后面的位置就不准确了
						stack.length == 1 && arr.unshift(ebOption);
								
					} else {
						var ebOption = stack.pop();
						ebOption.end = r.index;						// 结束位置
						ebOption.endOuter = r.index + r[0].length;	// 结束位置

						ebOption.template = function() {
							return tpl.substring(this.begin, this.end);
						}.call(ebOption);
					}
				};
				
				if(arr.length == 0) {
					return [];
				}
				
				return arr.reduce(function(arr, it, i) {
					it.scopeChain = jQuery.extend(true, [], me.scopeChain);
					var eachBlock = new EachBlock(it);
					arr.push(eachBlock);
					return arr;
				}, []);
			},
			
			getBlockById: function(id) {
				return this.children.filter(function(it, i) {
					return it.blockId == id;
				})[0];
			},
			
			getPlaceholderTemplate: function(html, begin, end) {
				var children = this.children;
				var tpl = this.template;
				children.forEach(function(block, i) {
					var beforeHTML = tpl.substring(0, block.beginOuter);
					var afterHTML = tpl.substring(block.endOuter, tpl.length);
					var id = getId();
					
					block.blockId = id;
					tpl = [
						beforeHTML, 
							'[', id, ']',
						afterHTML
					].join('');
				});
				
				return tpl;
			},
			
			isRoot: function() {
				return this.begin === undefined;
			}
		};
		
		function getId() {	// 获取一个唯一标识  形如 js.module.UserListWay-kipt646o
			return [
				Math.random().toString(36).slice(2, 10)
			].join('');
		}
		
		
	</script>
</body>
</html>