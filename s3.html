<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hexo</title>
  <style>
  	body *{
  		padding: 0px;
  		margin: 0px;
  		font-size: 14px;
  	}
  	body * {
  		border-bottom: 1px red solid;
  	}
  	.title {
  		font-weight: bold;
  		background: #acc;
  		padding-left: 10px
  	}
  	.title2 {
  		background: #ddd;
  		list-style: none;
  		padding-left: 60px
  	}
  	li{
  		padding: 3px 0 3px 110px;
  	}
	.hidden {
		display:none;
	}
  </style>
  <script src="//cdn.bootcss.com/jquery/1.12.1/jquery.js"></script>
</head>
<body>
	<div id=a></div>
	<script>
		
		var html = [
			'<ul>',
				'<each list=u>',
					'<li>用户: {u.user}/ 网站：{u.site}</li>',
				'</each>',
			'</ul>',
		].join('');
		
		$.get('data2', function(data) {
			var start = new Date().getTime();
			bon.complier(html);
			for(var i = 0; i < 10000; i ++) {
				bon.render(data);
			}
			var time = new Date().getTime() - start;
			alert(time);
		});
		
		var bon = function() {
		
			return {
				render: function(data) {
					var tpl = this.template;
					eval('var compilerTpl = []; with(data) { ' + tpl + '}');
					
					var result = compilerTpl.join('');
					compilerTpl = null;
					return result;
				},
				complier: function(html) {
					var r = /<\/?each\s?[^>]*>|<\/?if\s?[^>]*>/g;
					var htmlTags 	= html.split(r);	// html标签
					var customTags 	= html.match(r);	// 自定义标签（<each><if>）
					
					var len = Math.max(htmlTags.length, customTags.length);
				
					var compilerTpl = [], tpl = [];
					for(var i = 0; i < len; i ++) {
						if(htmlTags[i]) {
							var hTag = htmlTags[i];
							var hTag = hTag.replace(/{([^}]+)}/g, function(x, k) {
								return "' + (" + k + ") + '";
							});
							tpl.push("compilerTpl.push('" + hTag + "');");
						}
						if(customTags[i]) {
							var cTag = customTags[i];
							var reg = /<each\s+([\w.]+)\=['"]?(\w+)['"]?(?:\s+([\w.]+)\=['"]?(\w+)['"]?)*\s*>/g;
							cTag = cTag.replace(reg, function(x, arrVar, itemVar, countVar, indexVar) {
								return arrVar + '.forEach(function(' + itemVar + ', ' + indexVar + ') {';
							}).replace(/<if\s+([\w.]+)={1,2}['"]?(\w+)['"]?\s*>/g, function(x, v1, v2) {
								return 'if(' + v1 + ' == "' + v2 + '") { ';
							}).replace(/<\/if>/g, ' } \n ').replace(/<\/each>/g, ' }); \n');
							
							tpl.push(cTag);
						}
					}
					this.template = tpl.join('');
					compilerTpl = tpl = customTags = htmlTags = null;
				}
			}
		}();
		
		function bonTemplate(html, data) {
			
			var r = /<\/?each\s?[^>]*>|<\/?if\s?[^>]*>/g;
			var htmlTags 	= html.split(r);	// html标签
			var customTags 	= html.match(r);	// 自定义标签（<each><if>）
			
			var len = Math.max(htmlTags.length, customTags.length);
		
			var compilerTpl = [], tpl = [];
			for(var i = 0; i < len; i ++) {
				if(htmlTags[i]) {
					var hTag = htmlTags[i];
					var hTag = hTag.replace(/{([^}]+)}/g, function(x, k) {
						return "' + (" + k + ") + '";
					});
					tpl.push("compilerTpl.push('" + hTag + "');");
				}
				if(customTags[i]) {
					var cTag = customTags[i];
					var reg = /<each\s+([\w.]+)\=['"]?(\w+)['"]?(?:\s+([\w.]+)\=['"]?(\w+)['"]?)*\s*>/g;
					cTag = cTag.replace(reg, function(x, arrVar, itemVar, countVar, indexVar) {
						return arrVar + '.forEach(function(' + itemVar + ', ' + indexVar + ') {';
					}).replace(/<if\s+([\w.]+)={1,2}['"]?(\w+)['"]?\s*>/g, function(x, v1, v2) {
						return 'if(' + v1 + ' == "' + v2 + '") { ';
					}).replace(/<\/if>/g, ' } \n ').replace(/<\/each>/g, ' }); \n');
					
					tpl.push(cTag);
				}
			}
			
			
			eval('with(data) { ' + tpl.join('') + '}');
			var result = compilerTpl.join('');
			compilerTpl = tpl = data = customTags = htmlTags = null;
			return result;
		}
	
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
	</script>
</body>
</html>