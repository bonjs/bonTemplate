<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hexo</title>
  <style>
  	body *{
  		padding: 0px;
  		margin: 0px;
  		font-size: 14px;
  	}
  	body * {
  		border-bottom: 1px red solid;
  	}
  	.title {
  		font-weight: bold;
  		background: #acc;
  		padding-left: 10px
  	}
  	.title2 {
  		background: #ddd;
  		list-style: none;
  		padding-left: 60px
  	}
  	li{
  		padding: 3px 0 3px 110px;
  	}
	.hidden {
		display:none;
	}
  </style>
  <script src="//cdn.bootcss.com/jquery/1.12.1/jquery.js"></script>
</head>
<body>
	<button name=a>a</button>
	<button name=b>b</button>
	<div id=a>this is a</div>
	<div id=b></div>
	<script>
	
		/*
		新思路
		<div>{name}</div>
		<each list=l>
			<li>{l.name}</li>
			<each l.list=a>
				<li>{a.name}</li>
			</each>
		</each>

		var str = '';
		str += '<div>' + name + '</div>';
		list.forEach(function(it, i) {
			str += '<li>' + it.name + '</li>';
			it.list.forEach(function(t, i) {
				str += '<li>' + t.name + '</li>';
			});
		});
		*/
		
	
	
		$('button[name=a]').click(function(){
			$('#a').toggleClass('hidden');
		});
		$('button[name=b]').click(function(){
			$('#b').toggleClass('hidden');
		});
			
		$.get('getData', function(data) {
			console.log('begin');
			var html = [
				'<div>{title}</div>',
				'<div>',
					'<each departList="a">',
						'<div class="title">{a.departName}-{a.leaderName} 一级</div>',
						'<each a.group=b>',
							'<li class="title2">{b.groupName}组　二级</li>',
							'<each b.userList=c>',
								'<li>{c.name}({c.sex == "m" ?　"男" : "女"}) ({c.departName})　三级</li>',
								'<each c.list=d>',
									'<div style="padding-left: 160px"> --{d.name}　四级</div>',
									'<each d.list=e>',
										'<div style="padding-left: 200px">{e.name}　五级</div>',
										'<each e.list=f>',
											'<div style="padding-left: 260px">{f.name}　六级</div>',
											'<each f.list=g>',
												'<div style="padding-left: 300px">{g.name}　七级</div>',
												'<each g.list=h>',
													'<div style="padding-left: 360px">{h.name}　八级</div>',
													'<each h.list=i>',
														'<div style="padding-left: 400px">{i.name}　九级</div>',
													'</each>',
												'</each>',
											'</each>',
										'</each>',
									'</each>',
								'</each>',
							'</each>',
						'</each>',
					'</each>',
				'</div>',
			].join('');
			
			var html2 = [
				'<each departList="d">',
					'<div>{d.departName}</div>',
				'</each>',
			].join('');
			
			var start = new Date().getTime();
			
			var h = bonTemplate(html, data);
			var time = new Date().getTime() - start;
			
			console.log('time:', time);
			b.innerHTML = h;
		});
		
		
		function bonTemplate(html, data) {
			var n = new Node({
				template: html,
				scopeChain: [{
					scope: null,
					data: data
				}]
			});
			var html = n.getHtml();
			n = null;
			return html;
		}
		
		
		function EachBlock(opts) {
			for(var k in opts) {
				this[k] = opts[k];
			}
			this.childNodes = this.getNodes();
		}
		EachBlock.prototype = {
			getHtml: function() {
				var me = this;
				
				var html = [];
				this.childNodes.forEach(function(c, i) {
					html.push(c.getHtml());
				});
				this.childNodes = null;
				var h = html.join('');
				html = null;
				return h;
			},
			getNodes: function() {
				var me = this;
				var nodes = [];
				
				var matchs = /^(?:(\w+)\.)?(\w+)$/.exec(this.arrVar);
				var prefix = matchs[1], suffix = matchs[2];
				
				var data = this.getChainMappingValue(prefix, suffix);
				data && data.forEach(function(d, i) {
					// 取得父级作用域，再加上自己的作用域
					var scopeChain = cloneScopeChain(me.scopeChain);//jQuery.extend(true, [], me.scopeChain);
					scopeChain.push({
						scope		: me.itemVar,
						data		: d,
						countVar	: me.countVar,
						indexVar	: me.indexVar
					});
					var node = new Node({
						template	: me.template,
						scopeChain	: scopeChain,
					});
					scopeChain = null;
					nodes.push(node);
				});
				matchs = prefix = suffix = data = null;
				return nodes;
			},
			getChainMappingValue: function(prefix, suffix) {
				var arr = this.scopeChain.filter(function(s, i) {
					return s.scope == prefix;
				});
				var v = arr.length ? arr[0].data[suffix] : null;
				arr = null;
				return v;
			},
			
			getId: function() {
				return this.id = this.id || Math.random().toString(36).slice(2, 10);
			}
		};
		
		function Node(opts) {
			for(var k in opts) {
				this[k] = opts[k];
			}
			this.children = this.getBlocks();
			//this.template = this.getPlaceholderTemplate();	// 替换占位符后的template
			this.getPlaceholderTemplate();
		}
		
		Node.prototype = {
			
			getHtml: function() {
				var me = this;
				var html = this.template.replace(/{([^}]+)}/g, function(x, expression) {
					return me.getExpressionValue(expression);
				});
				//this.placeholderTemplate = null;
				
				if(this.children.length) {		// 如果有子block, 替换为子block.getHtml();
					html = html.replace(/\[#(\w+)\]/g, function(x, a) {
						var block = me.getBlockById(a);
						var h = block.getHtml();
						block = null;
						return h;
					});
				}
				
				return html;
			},
			
			// 根据表达式获取对应的值
			getExpressionValue: function(expression) {
			
				var sc 			= this.scopeChain;
				var scopeObject = {};
				sc.forEach(function(s) {
					if(s.scope) {
						scopeObject[s.scope] = s.data;
						scopeObject.countVar = s['countVar'];
						scopeObject.indexVar = s['indexVar'];
					}
				});
				var rootScopeData = sc[sc.length - 1].data;
				for(var k in rootScopeData) {
					scopeObject[k] = rootScopeData[k];
				}
				
				eval('with(scopeObject){ var returnVar = (' + expression + ') }');
				scopeObject = rootScopeData = sc = null;
				return returnVar;
			},
			
			getBlocks: function() {	// 获取一级子block(不包含二级以下block)
				var me = this;
				var tpl = this.template;
				var eachReg 		= /<\/?each[^>]*>/g;		// <each ..>或</each>
				var eachBeginReg 	= /<each\s+([\w.]+)=["']?(\w+)["']?\s*(?:\s+([\w.]+)=["']?(\w+)["']?)*\s*?>/;	// <each ..>
				
				var eMatch, stack = [], arr = [];
				
				while(eMatch = eachReg.exec(tpl)) {
					var result = eachBeginReg.exec(eMatch[0]);
					if(result) {
						// <each ..>
						var arrVar 		= result[1];
						var itemVar 	= result[2];
						var countVar	= result[3];
						var indexVar 	= result[4];
						
						stack.push({
							begin		: eMatch.index + eMatch[0].length,	// 开始位置(从block内容开始)
							beginOuter	: eMatch.index,						// 开始位置(从block开始)
							arrVar		: arrVar,
							itemVar		: itemVar,
							countVar	: countVar,
							indexVar	: indexVar
						});
					} else {
						// </each>
						var ebOption = stack.pop();
						ebOption.end = eMatch.index;							// 结束位置
						ebOption.endOuter = eMatch.index + eMatch[0].length;	// 结束位置

						ebOption.template = function() {
							return tpl.substring(this.begin, this.end);
						}.call(ebOption);
						
						if(stack.length == 0) {
							ebOption.scopeChain = cloneScopeChain(me.scopeChain);//jQuery.extend(true, [], me.scopeChain);
							var eachBlock = new EachBlock(ebOption);
							
							// 顺序要反序，因为替换成占位符时要用到开始和结束位置，如果先替换前面的，后面的位置发生变化就不准确了
							arr.push(eachBlock);
						}
						ebOption = null;
					}
					result = null;
				};
				eachBeginReg = eachReg = eMatch = stack = null;
				
				return arr;
			},
			
			getBlockById: function(id) {
				return this.children.filter(function(it) {
					return it.id == id;
				})[0];
			},
			
			getPlaceholderTemplate: function() {
				var tpl = this.template;
				this.children.length && this.children.forEach(function(block, i) {
					var beforeHTML 	= tpl.substring(0, block.beginOuter);			// 获取前面的html
					var afterHTML 	= tpl.substring(block.endOuter, tpl.length);	// 获取后面的html
					tpl = [
						beforeHTML, 
							'[#', block.getId(), ']',
						afterHTML
					].join('');
				});
				this.template = tpl;	
				return tpl;
			}
		};
		
		// 只clone非数组属性
		function cloneScopeChain(data) {
			
			var arr = [];
			for(var i = data.length - 1; i >= 0;  i --) {
				var o = {};
				var it = data[i];
				for(var k in it) {
					if(it[k]) {
						it[k].constructor != Array && (o[k] = it[k]);
					} else {
						o[k] = it[k]
					}
				}
				arr.push(o);
			}
			return arr;
			/*
			var chain = data.reduce(function(arr, it) {
				var o = {};
				for(var k in it) {
					if(it[k]) {
						it[k].constructor != Array && (o[k] = it[k]);
					} else {
						o[k] = it[k]
					}
				}
				arr.push(o);
				return arr;
			}, []);
			return chain;
			*/
		}
		
		
		
	</script>
</body>
</html>